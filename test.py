import streamlit as st
import numpy as np
import matplotlib.pyplot as plt
from datetime import datetime, timedelta

st.set_page_config(page_title="ìˆ˜ë©´ ë‹¨ê³„ ìê°€ ì§„ë‹¨", page_icon="ğŸ’¤")

st.title("ğŸ’¤ ìˆ˜ë©´ ë‹¨ê³„ ìê°€ ì„¤ë¬¸ ë° ë¶„ì„")

st.markdown("ì ìê¸° ì „ê³¼ ì¼ì–´ë‚œ í›„ ëŠë‚€ ì , ìˆ˜ë©´ ìŠµê´€ì„ ì„ íƒí•˜ê³ , ì·¨ì¹¨/ê¸°ìƒ ì‹œê°„ì„ ì…ë ¥í•˜ë©´ ìˆ˜ë©´ ì§ˆì„ í‰ê°€í•˜ê³  ê·¸ë˜í”„ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.")

# -----------------------------
# ìˆ˜ë©´ ì‹œê°„ ì…ë ¥
# -----------------------------
st.subheader("ğŸ•’ ìˆ˜ë©´ ì‹œê°„ ì…ë ¥")

sleep_date = st.date_input("ì·¨ì¹¨ ë‚ ì§œ", key="sleep_date")
sleep_time = st.time_input("ì·¨ì¹¨ ì‹œê°", key="sleep_time")
wake_date = st.date_input("ê¸°ìƒ ë‚ ì§œ", key="wake_date")
wake_time = st.time_input("ê¸°ìƒ ì‹œê°", key="wake_time")

sleep_dt = datetime.combine(sleep_date, sleep_time)
wake_dt = datetime.combine(wake_date, wake_time)

if wake_dt <= sleep_dt:
    st.warning("âš ï¸ ê¸°ìƒ ì‹œê°ì€ ë°˜ë“œì‹œ ì·¨ì¹¨ ì‹œê° ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤!")

# -----------------------------
# ì„¤ë¬¸ì§€ (10ë¬¸í•­)
# -----------------------------
st.subheader("ğŸ“ ìˆ˜ë©´ ìê°€ ì„¤ë¬¸ì§€")

q1 = st.radio("1. ì ë“¤ê¸° ì „ì— ê¸°ë¶„ì€ ì–´ë• ë‚˜ìš”?", ["ë§¤ìš° í¸ì•ˆí–ˆë‹¤", "ë³´í†µì´ì—ˆë‹¤", "ë¶ˆì•ˆí–ˆë‹¤"], key="q1")
q2 = st.radio("2. ë°¤ì¤‘ì— ëª‡ ë²ˆì´ë‚˜ ê¹¼ë‚˜ìš”?", ["ì „í˜€ ê¹¨ì§€ ì•Šì•˜ë‹¤", "1~2ë²ˆ ê¹¼ë‹¤", "3ë²ˆ ì´ìƒ ê¹¼ë‹¤"], key="q2")
q3 = st.radio("3. ì•„ì¹¨ì— ëˆˆì„ ë–´ì„ ë•Œ ê¸°ë¶„ì€?", ["ê°œìš´í•˜ë‹¤", "ë³´í†µì´ë‹¤", "ì—¬ì „íˆ í”¼ê³¤í•˜ë‹¤"], key="q3")
q4 = st.radio("4. ì¼ì–´ë‚œ í›„ ì§‘ì¤‘ë ¥ì€ ì–´ë–¤ê°€ìš”?", ["ë§¤ìš° ì¢‹ë‹¤", "ë³´í†µì´ë‹¤", "ì¢‹ì§€ ì•Šë‹¤"], key="q4")
q5 = st.radio("5. í‰ì†Œ ì ë“¤ê¸°ê¹Œì§€ ê±¸ë¦¬ëŠ” ì‹œê°„ì€?", ["10ë¶„ ì´ë‚´", "30ë¶„ ì´ë‚´", "1ì‹œê°„ ì´ìƒ"], key="q5")
q6 = st.radio("6. ìŠ¤ë§ˆíŠ¸í°/TVë¥¼ ë³´ë©° ì ë“¤ì—ˆë‚˜ìš”?", ["ì „í˜€ ê·¸ë ‡ì§€ ì•Šë‹¤", "ê°€ë” ê·¸ë ‡ë‹¤", "ìì£¼ ê·¸ë ‡ë‹¤"], key="q6")
q7 = st.radio("7. ì ìê¸° ì „ ì¹´í˜ì¸(ì»¤í”¼, ì°¨, ìŒë£Œ)ì„ ì„­ì·¨í–ˆë‚˜ìš”?", ["ì•„ë‹ˆì˜¤", "ê°€ë”", "ì˜ˆ"], key="q7")
q8 = st.radio("8. ìˆ˜ë©´ ì¤‘ ì½”ê³¨ì´ë‚˜ ë¬´í˜¸í¡ì´ ìˆë‚˜ìš”?", ["ì—†ë‹¤", "ê°€ë” ìˆë‹¤", "ìì£¼ ìˆë‹¤"], key="q8")
q9 = st.radio("9. ê¿ˆì„ ë§ì´ ê¾¼ë‹¤ê³  ëŠë¼ë‚˜ìš”?", ["ê±°ì˜ ì—†ë‹¤", "ê°€ë” ê¾¼ë‹¤", "ìì£¼ ê¾¼ë‹¤"], key="q9")
q10 = st.radio("10. ì•„ì¹¨ì— ì¼ì–´ë‚˜ í™œë™í•  ì˜ìš•ì€?", ["ë§¤ìš° ë†’ë‹¤", "ë³´í†µì´ë‹¤", "ê±°ì˜ ì—†ë‹¤"], key="q10")

# -----------------------------
# ë¶„ì„ ë²„íŠ¼
# -----------------------------
if st.button("ğŸ“Š ê²°ê³¼ ë³´ê¸°", key="result_btn"):

    total_sleep = (wake_dt - sleep_dt).total_seconds() / 3600  # ì´ ìˆ˜ë©´ ì‹œê°„(ì‹œê°„ ë‹¨ìœ„)

    # ì ìˆ˜ ê³„ì‚° (ë¬¸í•­ë³„ ê°€ì¤‘ì¹˜)
    score = 100
    if q1 == "ë¶ˆì•ˆí–ˆë‹¤": score -= 10
    if q2 == "1~2ë²ˆ ê¹¼ë‹¤": score -= 8
    if q2 == "3ë²ˆ ì´ìƒ ê¹¼ë‹¤": score -= 20
    if q3 == "ì—¬ì „íˆ í”¼ê³¤í•˜ë‹¤": score -= 15
    if q4 == "ì¢‹ì§€ ì•Šë‹¤": score -= 10
    if q5 == "1ì‹œê°„ ì´ìƒ": score -= 12
    if q6 == "ìì£¼ ê·¸ë ‡ë‹¤": score -= 8
    if q7 == "ì˜ˆ": score -= 5
    if q8 == "ìì£¼ ìˆë‹¤": score -= 15
    if q9 == "ìì£¼ ê¾¼ë‹¤": score -= 5
    if q10 == "ê±°ì˜ ì—†ë‹¤": score -= 10

    # ìˆ˜ë©´ ì‹œê°„ ë³´ì •
    if total_sleep < 6: score -= 15
    elif total_sleep > 9: score -= 8

    score = max(0, min(100, score))  # 0~100 ì‚¬ì´ë¡œ ì œí•œ

    # ê²°ê³¼ ì¶œë ¥
    st.success(f"ğŸŒ™ ì´ ìˆ˜ë©´ ì‹œê°„: {total_sleep:.1f} ì‹œê°„")
    st.success(f"âœ¨ ìˆ˜ë©´ì˜ ì§ˆ ì ìˆ˜: **{score}ì  / 100ì **")

    # í•´ì„ ë©”ì‹œì§€
    if score >= 80:
        st.info("âœ… ìˆ˜ë©´ì˜ ì§ˆì´ ë§¤ìš° ì¢‹ìŠµë‹ˆë‹¤. ì§€ê¸ˆ ìƒí™œ ìŠµê´€ì„ ìœ ì§€í•˜ì„¸ìš”!")
    elif score >= 60:
        st.info("ğŸ˜ ìˆ˜ë©´ì˜ ì§ˆì´ ë³´í†µ ìˆ˜ì¤€ì…ë‹ˆë‹¤. ì¹´í˜ì¸ ì„­ì·¨ë‚˜ ì „ìê¸°ê¸° ì‚¬ìš©ì„ ì¤„ì´ë©´ ë” ì¢‹ì•„ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    else:
        st.info("âš ï¸ ìˆ˜ë©´ì˜ ì§ˆì´ ë‚®ìŠµë‹ˆë‹¤. ê·œì¹™ì ì¸ ì·¨ì¹¨ ì‹œê°„, ì „ìê¸°ê¸° ì¤„ì´ê¸°, ìˆ˜ë©´ í™˜ê²½ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.")

    # -----------------------------
    # ìˆ˜ë©´ ë‹¨ê³„ ì‹œë®¬ë ˆì´ì…˜ ê·¸ë˜í”„
    # -----------------------------
    st.subheader("ğŸ“ˆ ì˜ˆìƒ ìˆ˜ë©´ ë‹¨ê³„ ë³€í™”")

    # ë‹¨ê³„: 0=ê¹Šì€ìˆ˜ë©´, 1=ì–•ì€ìˆ˜ë©´, 2=REM, 3=ê°ì„±
    cycle = [1, 0, 1, 2]  # ì–•ì€ â†’ ê¹Šì€ â†’ ì–•ì€ â†’ REM (90ë¶„ ì£¼ê¸°)
    stages = []
    timestamps = []

    t = sleep_dt
    while t < wake_dt:
        for c in cycle:
            stages.append(c)
            timestamps.append(t)
            t += timedelta(minutes=90/len(cycle))  # ê° ë‹¨ê³„ ì•½ 22.5ë¶„
            if t >= wake_dt:
                break

    fig, ax = plt.subplots(figsize=(10,4))
    ax.step(timestamps, stages, where="post", linewidth=2)

    # ìƒ‰ìƒ ì˜ì—­ ì±„ìš°ê¸°
    colors = {0:"navy", 1:"skyblue", 2:"orange", 3:"red"}
    for i in range(len(stages)-1):
        ax.fill_between([timestamps[i], timestamps[i+1]], stages[i], stages[i+1],
                        step="post", color=colors[stages[i]], alpha=0.3)

    ax.set_yticks([0,1,2,3])
    ax.set_yticklabels(["ê¹Šì€ ìˆ˜ë©´", "ì–•ì€ ìˆ˜ë©´", "REM", "ê°ì„±"])
    ax.invert_yaxis()
    ax.set_xlabel("ì‹œê°„")
    ax.set_ylabel("ìˆ˜ë©´ ë‹¨ê³„")
    ax.set_title("ì˜ˆìƒ ìˆ˜ë©´ ì£¼ê¸° ê·¸ë˜í”„")

    st.pyplot(fig)

    # ê·¸ë˜í”„ ì„¤ëª…
    st.markdown("""
    ### ğŸ“Œ ê·¸ë˜í”„ í•´ì„¤
    - **ê¹Šì€ ìˆ˜ë©´ (íŒŒë€ìƒ‰)**: ì‹ ì²´ íšŒë³µê³¼ ì„±ì¥ í˜¸ë¥´ëª¬ ë¶„ë¹„ê°€ í™œë°œíˆ ì¼ì–´ë‚˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤.  
    - **ì–•ì€ ìˆ˜ë©´ (í•˜ëŠ˜ìƒ‰)**: ì‰½ê²Œ ê¹° ìˆ˜ ìˆëŠ” ë‹¨ê³„ë¡œ, ì „ì²´ ìˆ˜ë©´ì˜ ì ˆë°˜ ì´ìƒì„ ì°¨ì§€í•©ë‹ˆë‹¤.  
    - **REM ìˆ˜ë©´ (ì£¼í™©ìƒ‰)**: ê¿ˆì„ ê¾¸ëŠ” ë‹¨ê³„ì´ë©°, ë‡Œê°€ í™œë°œíˆ í™œë™í•˜ë©´ì„œ ê¸°ì–µê³¼ ê°ì •ì„ ì •ë¦¬í•©ë‹ˆë‹¤.  
    - **ê°ì„± (ë¹¨ê°„ìƒ‰)**: ê¹¨ì–´ ìˆëŠ” ìƒíƒœë¡œ, ì¤‘ê°„ì¤‘ê°„ ì§§ì€ ê°ì„±ì´ ë‚˜íƒ€ë‚˜ëŠ” ê²ƒì€ ì •ìƒì…ë‹ˆë‹¤.  

    ì¼ë°˜ì ìœ¼ë¡œ **90ë¶„ ì£¼ê¸°ë¡œ ì–•ì€ ìˆ˜ë©´ â†’ ê¹Šì€ ìˆ˜ë©´ â†’ REM â†’ ì–•ì€ ìˆ˜ë©´**ì´ ë°˜ë³µë©ë‹ˆë‹¤.  
    ì´ ê·¸ë˜í”„ëŠ” ì…ë ¥ëœ ì·¨ì¹¨/ê¸°ìƒ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ **ì˜ˆìƒë˜ëŠ” ì „í˜•ì ì¸ ìˆ˜ë©´ íŒ¨í„´**ì„ ì‹œë®¬ë ˆì´ì…˜í•œ ê²ƒì…ë‹ˆë‹¤.
    """)
